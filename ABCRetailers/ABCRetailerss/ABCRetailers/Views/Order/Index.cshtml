@using ABCRetailers.Models
@model IEnumerable<ABCRetailers.Models.Order>
@{
    ViewData["Title"] = "Orders";
}

<div class="container-fluid py-4" style="background-color:#f5f7fa; min-height:100vh;">
    <div class="card shadow-lg border-0 rounded-4">
        <div class="card-header bg-gradient text-white d-flex justify-content-between align-items-center rounded-top-4"
             style="background: linear-gradient(90deg, #007bff 0%, #00c2ff 100%);">
            <h3 class="mb-0 fw-bold"><i class="fas fa-shopping-cart me-2"></i> Orders</h3>
            <a asp-action="Create" class="btn btn-light fw-semibold shadow-sm">
                <i class="fas fa-plus-circle text-primary"></i> Create Order
            </a>
        </div>

        <div class="card-body bg-white rounded-bottom-4">
            @if (Model != null && Model.Any())
            {
                <div class="table-responsive">
                    <table class="table table-bordered align-middle text-center table-hover">
                        <thead class="table-primary text-dark">
                            <tr>
                                <th>Order ID</th>
                                <th>Customer</th>
                                <th>Product</th>
                                <th>Order Date (Local)</th>
                                <th>Qty</th>
                                <th>Total</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var order in Model.OrderByDescending(o => o.OrderDateUtc))
                            {
                                <tr>
                                    <td><code>@(order.Id?.Length > 8 ? order.Id[..8] + "…" : order.Id)</code></td>
                                    <td>@order.CustomerId</td>
                                    <td>@(!string.IsNullOrWhiteSpace(order.ProductName) ? order.ProductName : order.ProductId)</td>
                                    <td>@FormatLocal(order.OrderDateUtc)</td>
                                    <td>@order.Quantity</td>
                                    <td>@order.TotalAmount.ToString("C")</td>
                                    <td>
                                        <span class="badge bg-@Badge(order.Status) px-3 py-2">@order.Status</span>
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <a asp-action="Details" asp-route-id="@order.Id" class="btn btn-sm btn-outline-info" title="Details">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <a asp-action="Edit" asp-route-id="@order.Id" class="btn btn-sm btn-outline-primary" title="Edit">
                                                <i class="fas fa-edit"></i>
                                            </a>

                                            @if (order.Status is not OrderStatus.Completed and not OrderStatus.Cancelled)
                                            {
                                                <div class="btn-group" role="group">
                                                    <button type="button" class="btn btn-sm btn-outline-warning dropdown-toggle"
                                                            data-bs-toggle="dropdown" title="Update Status">
                                                        <i class="fas fa-sync-alt"></i>
                                                    </button>
                                                    <ul class="dropdown-menu shadow">
                                                        @if (order.Status == OrderStatus.Submitted)
                                                        {
                                                            <li>
                                                                <a class="dropdown-item" href="#"
                                                                   onclick="updateOrderStatus('@order.Id','Processing')">
                                                                    <i class="fas fa-cog text-info me-1"></i> Mark as Processing
                                                                </a>
                                                            </li>
                                                        }
                                                        @if (order.Status == OrderStatus.Processing)
                                                        {
                                                            <li>
                                                                <a class="dropdown-item" href="#"
                                                                   onclick="updateOrderStatus('@order.Id','Completed')">
                                                                    <i class="fas fa-check text-success me-1"></i> Mark as Completed
                                                                </a>
                                                            </li>
                                                        }
                                                        <li>
                                                            <a class="dropdown-item" href="#"
                                                               onclick="updateOrderStatus('@order.Id','Cancelled')">
                                                                <i class="fas fa-times text-danger me-1"></i> Cancel Order
                                                            </a>
                                                        </li>
                                                    </ul>
                                                </div>
                                            }

                                            <button type="button" class="btn btn-sm btn-outline-danger"
                                                    onclick="confirmDelete('@order.Id','@order.Id')" title="Delete">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="alert alert-info text-center mt-4">
                    <i class="fas fa-info-circle me-1"></i> No orders found.
                    <a asp-action="Create" class="alert-link">Create your first order</a>!
                </div>
            }
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title fw-bold"><i class="fas fa-exclamation-triangle me-2"></i> Confirm Delete</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete order <strong id="orderId"></strong>?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="deleteForm" method="post" style="display:inline;">
                    @Html.AntiForgeryToken()
                    <button type="submit" class="btn btn-danger">Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Hidden AntiForgery token for AJAX -->
<form id="__af" method="post" style="display:none">
    @Html.AntiForgeryToken()
</form>

@section Scripts {
    <script>
        function confirmDelete(orderIdFull, orderIdForDisplay) {
            const shortId = (orderIdForDisplay && orderIdForDisplay.length > 8)
                ? orderIdForDisplay.substring(0, 8) + '…' : orderIdForDisplay;
            document.getElementById('orderId').textContent = shortId;
            document.getElementById('deleteForm').action =
                '@Url.Action("Delete", "Order")/' + encodeURIComponent(orderIdFull);
            new bootstrap.Modal(document.getElementById('deleteModal')).show();
        }

        function updateOrderStatus(orderId, newStatus) {
            if (!confirm(`Are you sure you want to change the status to "${newStatus}"?`)) return;

            const token = document.querySelector('#__af input[name="__RequestVerificationToken"]').value;
            const body = new URLSearchParams({
                id: orderId,
                newStatus: newStatus,
                __RequestVerificationToken: token
            });

            fetch('@Url.Action("UpdateOrderStatus", "Order")', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8' },
                body
            })
            .then(r => r.json())
            .then(data => {
                if (data && data.success) location.reload();
                else alert('Error: ' + (data && data.message ? data.message : 'Unknown error'));
            })
            .catch(() => alert('An error occurred while updating the status'));
        }
    </script>
}

@functions {
    string FormatLocal(DateTimeOffset? dto)
        => dto.HasValue ? dto.Value.ToLocalTime().ToString("yyyy-MM-dd HH:mm") : "-";

    string Badge(OrderStatus status) => status switch
    {
        OrderStatus.Submitted => "primary",
        OrderStatus.Processing => "info",
        OrderStatus.Completed => "success",
        OrderStatus.Cancelled => "danger",
        _ => "secondary"
    };
}
